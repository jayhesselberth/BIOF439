---
title: "Adding to the story: Annotations, maps and interactions"
author: Abhijit Dasgupta, PhD
date: Spring 2019

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = '#> ', message = F, cache=T)
library(tidyverse)
theme_set(theme_bw())
```

layout: true

<div class="my-header">
<span>BIOF 439, Spring 2019</span></div>


---
class:middle, center, inverse

# Annotations

---

## Stand-alone stories

- You would like a data visualization to stand on its own
- Relevant information should be placed on the graph
- However, you need to balance the information content with real estate
    - Don't clutter the graph and make it not readable

---
    

## An example 

<div id="origecon"></div>
![](img/economist1.gif)

---

## Reconstructing this annotated graph

.pull-left[
```{r a1, eval = F, echo = T, message=F}
library(tidyverse)
econ_data <- rio::import('data/EconomistData.csv')
ggplot(econ_data,
       aes(x = CPI, y = HDI, color=Region))+
  geom_point()
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "a1"}
```
]

---

## Reconstructing this annotated graph

.pull-left[
```{r a2, eval = F, echo = T}
ggplot(econ_data,
       aes(x = CPI, y = HDI, color=Region))+
  geom_point() +
  geom_smooth(color='red', se=F)
```

#### Add a trend line
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "a2", message=F}
```
]

---

## Reconstructing this annotated graph

.pull-left[
```{r a3, eval = F, echo = T, message=F}
ggplot(econ_data,
       aes(x = CPI, y = HDI, color=Region))+
  geom_smooth(color='red', se=F) + #<<
  geom_point()#<<
```

#### Reverse order so points are above line
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "a3"}
```
]

---

## Reconstructing this annotated graph

.pull-left[
```{r a4, eval = F, echo = T}
ggplot(econ_data,
       aes(x = CPI, y = HDI, color=Region))+
  geom_smooth(color='red', se=F) + 
  geom_point(shape = 1, size = 4, stroke=1.25)#<<

```

#### Different shape for points
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "a4"}
```
]

---

## Reconstructing this annotated graph

.pull-left[
```{r a5, eval = F, echo = T}
pointsToLabel <- c("Russia", "Venezuela", "Iraq", "Myanmar", "Sudan",
                   "Afghanistan", "Congo", "Greece", "Argentina", "Brazil",
                   "India", "Italy", "China", "South Africa", "Spane",
                   "Botswana", "Cape Verde", "Bhutan", "Rwanda", "France",
                   "United States", "Germany", "Britain", "Barbados", "Norway", "Japan",
                   "New Zealand", "Singapore")
ggplot(econ_data,
       aes(x = CPI, y = HDI, color=Region))+
  geom_smooth(color='red', se=F) + 
  geom_point(shape = 1, size = 4, stroke=1.25) + 
  geom_text(aes(label=Country),
            color = 'gray20')
```

#### Label countries
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "a5"}
```
]

---

## Reconstructing this annotated graph

.pull-left[
```{r a6, eval = F, echo = T}
pointsToLabel <- c("Russia", "Venezuela", "Iraq", "Myanmar", "Sudan",
                   "Afghanistan", "Congo", "Greece", "Argentina", "Brazil",
                   "India", "Italy", "China", "South Africa", "Spane",
                   "Botswana", "Cape Verde", "Bhutan", "Rwanda", "France",
                   "United States", "Germany", "Britain", "Barbados", "Norway", "Japan",
                   "New Zealand", "Singapore")
ggplot(econ_data,
       aes(x = CPI, y = HDI, color=Region))+
  geom_smooth(color='red', se=F) + 
  geom_point(shape = 1, size = 4, stroke=1.25) + 
  geom_text(aes(label=Country),
            color = 'gray20', 
            data = econ_data %>% #<<
              filter(Country %in% pointsToLabel))#<<
```

#### Better, but labels are overlayed on points
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "a6"}
```
]

---

## Reconstructing this annotated graph

.pull-left[
```{r a7, eval = F, echo = T}
library(ggrepel) #<<
pointsToLabel <- c("Russia", "Venezuela", "Iraq", "Myanmar", "Sudan",
                   "Afghanistan", "Congo", "Greece", "Argentina", "Brazil",
                   "India", "Italy", "China", "South Africa", "Spane",
                   "Botswana", "Cape Verde", "Bhutan", "Rwanda", "France",
                   "United States", "Germany", "Britain", "Barbados", "Norway", "Japan",
                   "New Zealand", "Singapore")
(plt <- ggplot(econ_data,
       aes(x = CPI, y = HDI, color=Region))+
  geom_smooth(color='red', se=F) + 
  geom_point(shape = 1, size = 4, stroke=1.25) + 
  geom_text_repel(aes(label=Country),#<<
            color = 'gray20', 
            force=20,
            data = econ_data %>% 
              filter(Country %in% pointsToLabel)))
```

]
.pull-right[
```{r, eval = T, echo = F, ref.label = "a7"}
```
]

---

## Reconstructing this annotated graph

.pull-left[

Let's re-order the regions

```{r a8, eval = F, echo = T}
econ_data$Region <- 
  factor(econ_data$Region,
         levels = c("EU W. Europe",
                    "Americas",
                    "Asia Pacific",
                    "East EU Cemt Asia",
                    "MENA",
                    "SSA"),
         labels = c("OECD",
                    "Americas",
                    "Asia &\nOceania",
                    "Central &\nEastern Europe",
                    "Middle East &\nnorth Africa",
                    "Sub-Saharan\nAfrica"))

plt$data = econ_data #<<
plt #<<
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "a8"}
```
]

---

## Reconstructing this annotated graph

.pull-left[
Clean up the graphic
```{r a9, eval = F, echo = T}
plt +
  scale_x_continuous(name = 'Corruption Perceptions Index',
                     breaks = 1:10) +
  scale_y_continuous(name="Human Development Index",
                     breaks = seq(0.2, 1, by = 0.1))+
  scale_color_manual(name = '',
                     values = c("#24576D",
                                "#099DD7",
                                "#28AADC",
                                "#248E84",
                                "#F2583F",
                                "#96503F")) +
  ggtitle("Corruption and Human development")+
  theme_bw()+
  theme(legend.position='top',
        legend.direction='horizontal')
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "a9"}
```
]


---
class:middle,center

# Adding derived statistics to a plot

---

## Adding group means

.pull-left[
```{r b1, eval = F, echo = T}
ggplot(iris, 
       aes(x = Sepal.Length,
           y = Sepal.Width,
           color = Species))+
  geom_point()+
  theme_bw()
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "b1"}
```
]

---

## Adding group means

.pull-left[
```{r, eval = T, echo = T}
means <- iris %>% group_by(Species) %>% 
  summarize_at(vars(starts_with('Sepal')),
               mean)
means
```


```{r b2, eval = F, echo = T}
ggplot(iris, 
       aes(x = Sepal.Length,
           y = Sepal.Width,
           color = Species))+
  geom_point() + 
  geom_point(data = means, #<<
             size=5) +#<<
  theme_bw()
```


```{r, eval = T, echo = T}
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "b2"}
```
]
---

## Adding regression metrics

.pull-left[

Regress highway mileage on city mileage (data: mpg)

```{r c1, eval = F, echo = T}
mod1 <- lm(hwy ~ cty, data = mpg)
r2 <- broom::glance(mod1) %>% pull(r.squared)

ggplot(mpg, 
       aes(x = cty, y = hwy))+
  geom_point() + 
  geom_smooth(method = 'lm', se=F) +
  theme_bw()
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "c1"}
```
]

---

## Adding regression metrics

.pull-left[

Regress highway mileage on city mileage (data: mpg)

```{r c2, eval = F, echo = T}
mod1 <- lm(hwy ~ cty, data = mpg)
r2 <- broom::glance(mod1) %>% pull(r.squared) %>% 
  round(., 2)

ggplot(mpg, 
       aes(x = cty, y = hwy))+
  geom_point() + 
  geom_smooth(method = 'lm', se=F)+
  annotate(geom='text',
           x = 15, y = 40,
           label=glue::glue("R^2 == {r}",r=r2),
           size=12,
           parse=T) + 
  theme_bw()
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "c2"}
```
]

---

## Highlighting regions

.pull-left[
```{r d1, eval = F, echo = T}
mpg %>% 
  mutate(cyl = as.factor(cyl)) %>% 
  ggplot(aes(x = cyl, y = hwy)) + 
  geom_boxplot() + 
  theme_bw()
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "d1"}
```
]

---

## Highlighting regions

.pull-left[
```{r d2, eval = F, echo = T}
mpg %>% 
  mutate(cyl = as.factor(cyl)) %>% 
  ggplot(aes(x = cyl, y = hwy)) + 
  geom_boxplot() + 
  theme_bw()+
  annotate(geom = 'rect',
           xmin=3.75,xmax=4.25,
           ymin = 22, ymax = 28,
           fill = 'red',
           alpha = 0.2) +
  annotate('text', 
           x = 4.5, y = 25,
           label = 'Outliers?',
           hjust = 0)+
  coord_cartesian(xlim = c(0,5))+ 
  theme_bw()
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "d2"}
```
]


---
class:center, middle,inverse

# Maps

---

For maps, we need a couple of new packages. 

- `sf`: Simple features in R
- `rnaturalearth` & `rnaturalearthdata`: map data

---

.pull-left[
```{r e1, eval = F, echo = T}
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)

world <- ne_countries(scale='medium', returnclass='sf')
ggplot(data = world) + 
  geom_sf()
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "e1"}
```
]

---

.pull-left[
```{r e2, eval = F, echo = T}
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)

world <- ne_countries(scale='medium', returnclass='sf')
ggplot(data = world) + 
  geom_sf(aes(fill = pop_est))
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "e2"}
```
]

---

.pull-left[
```{r e3, eval = F, echo = T}
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)

world <- ne_countries(scale='medium', returnclass='sf')
ggplot(data = world) + 
  geom_sf(aes(fill = pop_est))+
  scale_fill_viridis_c(option = 'plasma', trans='sqrt')
  
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "e3"}
```
]

---

## Looking at Florida

.pull-left[
```{r f1, eval = F, echo = T}
library(maps)
states <- st_as_sf(map('state', plot = F, fill = T)) %>% 
  cbind(st_coordinates(st_centroid(states))) %>% 
  mutate(ID = str_to_title(ID))

ggplot(data = world)+
  geom_sf() + 
  geom_sf(data = states, fill = NA) + 
  geom_text(data = states, aes(X, Y, label = ID), 
            size = 5) + 
  coord_sf(xlim = c(-88, -78), ylim = c(24.5, 33), 
           expand = F)
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "f1", warning=F}
```
]

---

## Looking at Florida

.pull-left[
```{r f2, eval = F, echo = T}
library(maps)
states <- st_as_sf(map('state', plot = F, fill = T)) %>% 
  cbind(st_coordinates(st_centroid(states))) %>% 
  mutate(ID = str_to_title(ID))

ggplot(data = world)+
  geom_sf() + 
  geom_sf(data = states, fill = NA) + 
  geom_label(data = states, aes(X, Y, label = ID), #<<
            size = 5) + 
  coord_sf(xlim = c(-88, -78), ylim = c(24.5, 33), 
           expand = F)
```
]
.pull-right[
```{r, eval = T, echo = F, ref.label = "f2", warning=F}
```
]

---

